<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EternaLabs - Order Execution Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .content {
            padding: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .quick-test {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-test button {
            flex: 0;
            min-width: auto;
            padding: 8px 16px;
            font-size: 0.9em;
            background: #e9ecef;
            color: #333;
        }

        .quick-test button:hover {
            background: #dee2e6;
        }

        .status {
            margin-top: 20px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-id {
            font-family: monospace;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .events-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .event {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-time {
            color: #6c757d;
            font-size: 0.85em;
            margin-right: 10px;
        }

        .pending {
            border-left-color: #ffc107;
            background: #fff9e6;
        }

        .routing {
            border-left-color: #17a2b8;
            background: #e6f7f9;
        }

        .building {
            border-left-color: #6f42c1;
            background: #f3e6ff;
        }

        .submitted {
            border-left-color: #fd7e14;
            background: #fff3e6;
        }

        .confirmed {
            border-left-color: #28a745;
            background: #e6ffe6;
        }

        .failed {
            border-left-color: #dc3545;
            background: #ffe6e6;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 5px 0;
            color: #555;
            padding-left: 20px;
            position: relative;
        }

        .info-box li:before {
            content: "‚Üí";
            color: #667eea;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ EternaLabs Order Execution Engine</h1>
            <p>Real-time DEX routing with WebSocket updates | Deployed on Railway</p>
        </div>

        <div class="content">
            <div class="card">
                <h2>üìù Submit Order</h2>

                <div class="form-group">
                    <label for="tokenIn">Token In:</label>
                    <input type="text" id="tokenIn" value="SOL" placeholder="e.g., SOL, ETH, BTC">
                </div>

                <div class="form-group">
                    <label for="tokenOut">Token Out:</label>
                    <input type="text" id="tokenOut" value="USDC" placeholder="e.g., USDC, USDT">
                </div>

                <div class="form-group">
                    <label for="amountIn">Amount In:</label>
                    <input type="number" id="amountIn" value="1.5" step="0.1" min="0.1" placeholder="Enter amount">
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="submitOrder()">üöÄ Submit Order</button>
                    <button class="btn-secondary" onclick="clearOutput()">üóëÔ∏è Clear Output</button>
                </div>

                <div class="quick-test">
                    <strong style="width: 100%; margin-bottom: 5px;">Quick Test Cases:</strong>
                    <button onclick="setValues('SOL', 'USDC', 1.5)">SOL ‚Üí USDC (1.5)</button>
                    <button onclick="setValues('SOL', 'USDC', 0.5)">Small (0.5)</button>
                    <button onclick="setValues('SOL', 'USDT', 3.0)">Large (3.0)</button>
                    <button onclick="setValues('ETH', 'USDC', 2.0)">ETH ‚Üí USDC (2.0)</button>
                    <button onclick="setValues('BTC', 'USDT', 0.1)">BTC ‚Üí USDT (0.1)</button>
                </div>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat-box">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="confirmedOrders">0</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="activeOrders">0</div>
                    <div class="stat-label">Active</div>
                </div>
            </div>

            <div class="card status" id="status" style="display: none;">
                <div class="order-header">
                    <h2>üìä Order Status</h2>
                </div>
                <div id="events" class="events-container"></div>
            </div>

            <div class="info-box">
                <h3>üí° Demo Test Scenarios</h3>
                <ul>
                    <li>Submit multiple orders simultaneously to test concurrent processing</li>
                    <li>Try different token pairs (SOL/USDC, ETH/USDT, BTC/USDC)</li>
                    <li>Test with various amounts (small: 0.5, medium: 1.5, large: 3.0+)</li>
                    <li>Watch DEX routing decisions (Raydium vs Meteora)</li>
                    <li>Observe real-time status updates via WebSocket</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API URL based on current host
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? `http://localhost:${window.location.port || 3000}`
            : 'https://eternalabs-production.up.railway.app';
        let stats = { total: 0, confirmed: 0, active: 0 };
        let activeConnections = new Set();

        function setValues(tokenIn, tokenOut, amount) {
            document.getElementById('tokenIn').value = tokenIn;
            document.getElementById('tokenOut').value = tokenOut;
            document.getElementById('amountIn').value = amount;
        }

        function clearOutput() {
            document.getElementById('events').innerHTML = '';
            document.getElementById('status').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            stats = { total: 0, confirmed: 0, active: 0 };
            activeConnections.clear();
        }

        function updateStats() {
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('totalOrders').textContent = stats.total;
            document.getElementById('confirmedOrders').textContent = stats.confirmed;
            document.getElementById('activeOrders').textContent = stats.active;
        }

        async function submitOrder() {
            const tokenIn = document.getElementById('tokenIn').value;
            const tokenOut = document.getElementById('tokenOut').value;
            const amountIn = parseFloat(document.getElementById('amountIn').value);

            if (!tokenIn || !tokenOut || !amountIn || amountIn <= 0) {
                alert('Please fill in all fields with valid values');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/orders/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tokenIn, tokenOut, amountIn })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const orderId = data.orderId;

                stats.total++;
                updateStats();

                document.getElementById('status').style.display = 'block';

                // Add order header
                const orderHeader = document.createElement('div');
                orderHeader.className = 'order-id';
                orderHeader.innerHTML = `<strong>Order ${stats.total}:</strong> <code>${orderId}</code> | ${tokenIn} ‚Üí ${tokenOut} (${amountIn})`;
                document.getElementById('events').insertBefore(orderHeader, document.getElementById('events').firstChild);

                // Connect to WebSocket
                const wsUrl = `${API_URL.replace('https://', 'wss://')}/api/orders/execute?orderId=${orderId}`;
                const ws = new WebSocket(wsUrl);
                activeConnections.add(orderId);

                ws.onopen = () => {
                    console.log('WebSocket connected:', orderId);
                    ws.send(JSON.stringify({ subscribeOrderId: orderId }));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Order update:', orderId, data);

                    if (data.subscribed) {
                        addEvent(orderId, '‚úì Subscribed to order updates', 'pending');
                        return;
                    }

                    let message = `<strong>${data.status.toUpperCase()}</strong>`;

                    if (data.status === 'pending') {
                        // Increment active count when order actually starts processing
                        stats.active++;
                        updateStats();
                    } else if (data.status === 'routing') {
                        message += ' | Comparing DEX prices...';
                    } else if (data.status === 'building' && data.chosenDex) {
                        message += ` | <strong>DEX Selected:</strong> ${data.chosenDex}`;
                        if (data.quote) message += ` | <strong>Price:</strong> ${data.quote.price.toFixed(4)}`;
                    } else if (data.status === 'submitted') {
                        message += ` | Transaction sent to ${data.chosenDex || 'DEX'}`;
                    } else if (data.status === 'confirmed') {
                        message += ` | <strong>‚úì Success!</strong>`;
                        if (data.txHash) message += ` | <strong>TX:</strong> <code>${data.txHash.substring(0, 20)}...</code>`;
                        if (data.executedPrice) message += ` | <strong>Price:</strong> ${data.executedPrice.toFixed(4)}`;
                        stats.confirmed++;
                        stats.active = Math.max(0, stats.active - 1);
                        updateStats();
                    } else if (data.status === 'failed') {
                        message += ` | <strong>‚ùå Failed</strong>`;
                        if (data.error) message += ` | ${data.error}`;
                        stats.active = Math.max(0, stats.active - 1);
                        updateStats();
                    }

                    addEvent(orderId, message, data.status);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', orderId, error);
                    addEvent(orderId, '‚ùå WebSocket connection error', 'failed');
                };

                ws.onclose = () => {
                    console.log('WebSocket closed:', orderId);
                    activeConnections.delete(orderId);
                    if (activeConnections.size === 0) {
                        stats.active = 0;
                        updateStats();
                    }
                };

            } catch (error) {
                console.error('Error submitting order:', error);
                addEvent('error', `‚ùå Error: ${error.message}`, 'failed');
            }
        }

        function addEvent(orderId, message, status) {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${status}`;
            eventDiv.innerHTML = `
                <span class="event-time">[${new Date().toLocaleTimeString()}]</span>
                ${message}
            `;
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);

            // Auto-scroll if needed
            if (eventsDiv.scrollTop === 0) {
                eventsDiv.scrollTop = 0;
            }
        }

        // Show initial message
        window.addEventListener('load', () => {
            console.log('Demo client loaded. API URL:', API_URL);
        });
    </script>
</body>

</html>